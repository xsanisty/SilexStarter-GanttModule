{% set template = config.get('@silexstarter-dashboard.config.template') %}
{% extends '@silexstarter-dashboard/'~ template ~'/index.twig' %}

{% block stylesheet %}
    {{parent()}}

    {% if config.get('@xsanisty-gantt.gantt.pro_version_enabled') %}
        {{ stylesheet('@xsanisty-gantt/pro/dhtmlxgantt.css') }}
    {% else %}
        {{ stylesheet('@xsanisty-gantt/css/dhtmlxgantt.css') }}
    {% endif %}

    <style>
        html, body{ height:100%; padding:0px; margin:0px;}
        .gantt_task_line.gantt_dependent_task {
            background-color: #65c16f;
            border: 1px solid #3c9445;

        }
        .gantt_task_line.gantt_dependent_task .gantt_task_progress {
            background-color: #46ad51;
        }

        .content-wrapper, .right-side, .main-footer {
            margin-left: 0 !important;
        }
    </style>
{% endblock %}

{% block sidebar %}{% endblock %}
{% block navbar %}{% endblock %}
{% block breadcrumb %}{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">{{ chart.name }}</h3>
                    <div class="box-tools pull-right">
                        <button class="btn btn-box-tool" data-toggle="tooltip" title="refresh chart" type="button" id="btn-refresh"><i class="fa fa-refresh"></i></button>
                        <button class="btn btn-box-tool" data-toggle="tooltip" title="export to pdf" type="button" id="btn-export-pdf" onclick="gantt.exportToPDF()"><i class="fa fa-file-pdf-o"></i></button>
                        <button class="btn btn-box-tool" data-toggle="tooltip" title="export to png" type="button" id="btn-export-png" onclick="gantt.exportToPNG()"><i class="fa fa-image"></i></button>
                    </div>
                </div>
                <div class="box-body no-padding">
                    <div id="gantt-container" style="width:100%; height:520px;"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    {{parent()}}

    {% if config.get('@xsanisty-gantt.gantt.pro_version_enabled') %}
        {{ javascript('@xsanisty-gantt/pro/dhtmlxgantt.js') }}
    {% else %}
        {{ javascript('@xsanisty-gantt/js/dhtmlxgantt.js') }}
    {% endif %}


    {{ javascript(['@xsanisty-gantt/js/ext/dhtmlxgantt_quick_info.js','http://export.dhtmlx.com/gantt/api.js']) }}

    <script>
    function setScale(scale) {
        switch(scale) {
            case "hour":
                gantt.config.scale_unit = "day";
                gantt.config.step = 1;
                gantt.config.date_scale = "%d %M";
                gantt.config.subscales = [
                    {unit:"hour", step:1, date:"%G" }
                ];
                gantt.config.min_column_width = 20;
                gantt.config.scale_height = 27;
                gantt.templates.date_scale = null;
                break;
            case "day":
                gantt.config.scale_unit = "day";
                gantt.config.step = 1;
                gantt.config.date_scale = "%d %M";
                gantt.config.subscales = [];
                gantt.config.scale_height = 27;
                gantt.templates.date_scale = null;
                break;
            case "week":
                var weekScaleTemplate = function(date){
                    var dateToStr = gantt.date.date_to_str("%d %M");
                    var endDate = gantt.date.add(gantt.date.add(date, 1, "week"), -1, "day");
                    return dateToStr(date) + " - " + dateToStr(endDate);
                };

                gantt.config.scale_unit = "week";
                gantt.config.min_column_width = 40;
                gantt.config.step = 1;
                gantt.templates.date_scale = weekScaleTemplate;
                gantt.config.subscales = [
                    {unit:"day", step:1, date:"%D" }
                ];
                gantt.config.scale_height = 50;
                break;
            case "month":
                gantt.config.scale_unit = "month";
                gantt.config.date_scale = "%F, %Y";
                gantt.config.scale_height = 50;
                gantt.config.min_column_width = 40;

                gantt.config.subscales = [
                    {unit:"day", step:1, date:"%j" }
                ];
                break;
            case "quarter":
                gantt.config.scale_unit = "year";
                gantt.config.step = 1;
                gantt.config.date_scale = "%Y";
                gantt.config.min_column_width = 50;

                gantt.config.scale_height = 90;

                function quarterLabel(date){
                    var month = date.getMonth();
                    var q_num;

                    if(month >= 9){
                        q_num = 4;
                    }else if(month >= 6){
                        q_num = 3;
                    }else if(month >= 3){
                        q_num = 2;
                    }else{
                        q_num = 1;
                    }

                    return "Q" + q_num;
                }

                gantt.config.subscales = [
                    {unit:"quarter", step:1, template:quarterLabel},
                    {unit:"month", step:1, date:"%M" }
                ];
                break;
            case "year":
                gantt.config.scale_unit = "year";
                gantt.config.step = 1;
                gantt.config.date_scale = "%Y";
                gantt.config.min_column_width = 50;

                gantt.config.scale_height = 70;
                gantt.templates.date_scale = null;


                gantt.config.subscales = [
                    {unit:"month", step:1, date:"%M" }
                ];
                break;
            default:
                break;
        }
    }

    $('#btn-refresh').click(function(){
        gantt.load(global.ganttApi+'/task/');
    });
    $('body').removeClass('sidebar-collapse');

    gantt.config.grid_width = 0;

    for( var conf in global.ganttSettings.columns) {
        gantt.config.grid_width += parseFloat(global.ganttSettings.columns[conf].width);
    }

    setScale(global.ganttSettings.scale);

    gantt.config.columns  = global.ganttSettings.columns;
    gantt.config.xml_date = "%Y-%m-%d %H:%i:%s";
    gantt.config.readonly = true;

    /** gantt hook template */
    gantt.templates.task_text = function(start, end, task){
        if (!task.progress) {
            task.progress = 0;
        }
        return task.text+ ' [' +Math.round(task.progress*100)+ '%]';
    };

    gantt.init("gantt-container");
    gantt.load(global.ganttApi+'/task/');
    </script>

{% endblock %}
